# WAHA with Persistent Sessions on Render

This project provides a Dockerized version of WAHA Core (WhatsApp HTTP API) with persistent session storage using MongoDB Atlas. This prevents WhatsApp logouts on Render's free tier restarts.

## Files Overview

- `Dockerfile`: Builds the custom WAHA image with sync capabilities
- `sync.js`: Node.js script for syncing session files with MongoDB GridFS
- `start.sh`: Shell script to coordinate sync and WAHA startup
- `package.json`: Dependencies for the sync script
- `render.yaml`: Render deployment configuration (optional)

## Build Instructions

1. Ensure you have Docker installed
2. Build the image:
   ```bash
   docker build -t waha-persistent .
   ```

## Deployment on Render

### Option 1: Manual Setup

1. Create a new Web Service on Render
2. Connect your GitHub repository (or upload files)
3. Set the following environment variables:
   - `WHATSAPP_SESSIONS_MONGO_URL`: Your MongoDB Atlas connection string
   - `WHATSAPP_DEFAULT_ENGINE`: `GOWS`
   - `PORT`: `3000`
   - `WHATSAPP_API_KEY_EXCLUDE_PATH`: `ping,health`
   - `NODE_OPTIONS`: `--max-old-space-size=400` (Prevents memory issues on free tier)
   - `WAHA_DASHBOARD_USERNAME`: `admin` (Dashboard login username)
   - `WAHA_DASHBOARD_PASSWORD`: Auto-generated password for dashboard login
4. Set the Docker command to: `./start.sh`
5. Deploy

**Note:** `WAHA_API_KEY` is auto-generated by WAHA on startup and will appear in the logs.

### Option 2: Using render.yaml

1. Push the code to GitHub with the `render.yaml` file
2. Create a new Web Service on Render
3. Connect your GitHub repository
4. Render will automatically detect the `render.yaml` and configure the service
5. Only set the `WHATSAPP_SESSIONS_MONGO_URL` environment variable (others are auto-configured)
6. Deploy

**Note:** `WAHA_API_KEY` and `WAHA_DASHBOARD_PASSWORD` are auto-generated by WAHA/Render for security.

## MongoDB Setup

1. Create a MongoDB Atlas cluster
2. Create a database user with read/write permissions
3. Get the connection string and set it as `WHATSAPP_SESSIONS_MONGO_URL`

## Performance Optimizations

### Memory Management

The `NODE_OPTIONS=--max-old-space-size=400` setting limits Node.js memory usage to 400MB, which is crucial for Render's free tier that provides only 512MB RAM total. This prevents:

- Memory exhaustion causing app restarts
- Performance degradation from garbage collection
- Service unavailability due to OOM (Out of Memory) errors

**Why 400MB?** This leaves ~100MB for the WAHA core application and system processes, ensuring stable operation within the free tier limits.

### Engine Selection

Using `WHATSAPP_DEFAULT_ENGINE=GOWS` instead of the default engine reduces memory footprint while maintaining full WhatsApp functionality.

## How It Works

- On startup, the container downloads existing session files from MongoDB to `/app/.sessions`
- A background watcher monitors the sessions folder and uploads changes to MongoDB
- WAHA runs with persistent sessions across restarts

## Testing MongoDB Connection

Before deploying, test your MongoDB connection:

```bash
# Set your MongoDB URL
export WHATSAPP_SESSIONS_MONGO_URL="your-mongodb-connection-string"

# Test connection and list stored sessions
node sync.js --test-connection
```

This will:

- Verify the connection to MongoDB Atlas
- Show the database name
- List all session files currently stored in GridFS
- Display file sizes and upload dates

## Status Monitoring Page

The sync script includes a built-in status monitoring page that shows:

- MongoDB connection status
- Number of stored session files
- Local session files
- Real-time sync activity

### Access the Status Page

After deployment, visit: `https://your-render-app.onrender.com:3001/`

Or in local development:

```bash
# Start the watcher with status server
node sync.js --watch
# Then visit http://localhost:3001
```

## Accessing WAHA

### Web Dashboard

- **URL:** `https://your-service.onrender.com/dashboard`
- **Username:** `admin` (or check `WAHA_DASHBOARD_USERNAME` env var)
- **Password:** Check Render environment variables or logs for `WAHA_DASHBOARD_PASSWORD`

### API Authentication

### API Authentication

- **API Key:** Auto-generated by WAHA on startup - check the deployment logs for:
  ```
  WAHA_API_KEY: your-generated-api-key
  ```
- **Usage:** Include in headers: `X-API-Key: your-api-key`

### Status Page

- **URL:** `https://your-service.onrender.com:3001/`
- Shows MongoDB connection status and session sync information

## Troubleshooting

### MongoDB Authentication Failed

**Error:** `bad auth : authentication failed`

**Solutions:**

1. **Check your connection string format:**

   - Should be: `mongodb+srv://username:password@cluster.mongodb.net/database`
   - Replace `username`, `password`, `cluster`, and `database` with your actual values
   - Make sure there are no extra spaces or characters

2. **Verify credentials:**

   - Go to MongoDB Atlas → Database Access
   - Ensure your user has read/write permissions
   - Check if the password is correct (reset if needed)

3. **Database name:**

   - The database name in the URL should match your actual database
   - Default is often `test` or `admin` - create a specific database if needed

4. **Network access:**

   - In Atlas → Network Access, ensure your IP is whitelisted or set to 0.0.0.0/0 for testing

5. **Test locally:**
   ```bash
   export WHATSAPP_SESSIONS_MONGO_URL="your-connection-string"
   node sync.js --test-connection
   ```

### WAHA Startup Issues

**Error:** `No such file or directory` for entrypoint.sh

**Solution:** The startup script has been updated to use `npm start` instead of the entrypoint.sh file. If you still get errors, check the Render logs for the correct startup command.

### Memory Issues

**Error:** Out of memory or high memory usage

**Solution:** The `NODE_OPTIONS=--max-old-space-size=400` limits Node.js to 400MB. If you need more memory, consider upgrading to Render's paid plans.

### Session Sync Not Working

**Check:**

1. MongoDB connection is successful (no auth errors)
2. Status page shows files being uploaded/downloaded
3. WhatsApp sessions are actually created and used

### Status Page Not Loading

**URL:** `https://your-app.onrender.com:3001/`

**If not working:**

1. Check Render logs for status server startup: `[SYNC] Status server running on port 3001`
2. Ensure port 3001 is configured in render.yaml
3. Try accessing `https://your-app.onrender.com:3001/status` for JSON data

## Monitoring Data Sharing

### In Render Logs

Monitor your Render service logs for sync activity:

- `[SYNC] Starting download phase...`
- `[SYNC] Downloading session.key...`
- `[SYNC] Starting watch mode...`
- `[SYNC] Uploading session.key...`

### In MongoDB Atlas Dashboard

1. Go to your MongoDB Atlas cluster
2. Navigate to **Collections**
3. Look for the `sessions.files` and `sessions.chunks` collections
4. These contain your GridFS stored session files

### Manual Verification

You can also run the test command in your deployed Render service:

1. Go to Render dashboard → Your service → Shell
2. Run: `node sync.js --test-connection`
